<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getDatabase, ref, onValue, push, update, remove } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';

    // Firebase config (THAY B·∫∞NG CONFIG C·ª¶A B·∫†N!)
  const firebaseConfig = {
  apiKey : "AIzaSyBttecKohcpxLzxbcA8DvDgDylhgXIuGYA" , 
  authDomain : "coffee-spark-ai-barista-64aeb.firebaseapp.com" , 
  projectId : "coffee-spark-ai-barista-64aeb" , 
  storageBucket : "coffee-spark-ai-barista-64aeb.firebasestorage.app" , 
  messagingSenderId : "473497813295" , 
  appId : "1:473497813295:web:031a5ae19695670b9ce1da" 
    }
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const tasksRef = ref(database, 'tasks');

    // Current user role
    let currentRole = 'admin';
    let tasks = [];  // Will be loaded from Firebase

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadTasksFromFirebase();
        updateUIBasedOnRole();
    });

    // Load tasks from Firebase (real-time listener)
    function loadTasksFromFirebase() {
        onValue(tasksRef, (snapshot) => {
            const data = snapshot.val();
            tasks = data ? Object.entries(data).map(([id, task]) => ({ id: parseInt(id), ...task })) : [];
            
            // Sort by ID for consistent order
            tasks.sort((a, b) => a.id - b.id);
            
            // Load sample data if empty
            if (tasks.length === 0) {
                loadSampleData();
            } else {
                renderTasks();
                updateStatistics();
            }
        });
    }

    // Load sample data (one-time, if DB empty)
    function loadSampleData() {
        const sampleTasks = [
            {
                id: 1,
                name: 'Ph√°t tri·ªÉn module ƒëƒÉng nh·∫≠p',
                assignee: 'Nguy·ªÖn VƒÉn A',
                totalAmount: 40,
                completedAmount: 28,
                unit: 'gi·ªù',
                status: 'ƒêang th·ª±c hi·ªán',
                priority: 'Cao',
                deadline: '2024-11-30',
                issues: 'Ch·ªù API t·ª´ backend'
            },
            // ... (th√™m c√°c sample kh√°c nh∆∞ code c≈©)
            {
                id: 2,
                name: 'Thi·∫øt k·∫ø giao di·ªán trang ch·ªß',
                assignee: 'Tr·∫ßn Th·ªã B',
                totalAmount: 20,
                completedAmount: 20,
                unit: 'gi·ªù',
                status: 'Ho√†n th√†nh',
                priority: 'Trung b√¨nh',
                deadline: '2024-11-15',
                issues: ''
            },
            {
                id: 3,
                name: 'Vi·∫øt t√†i li·ªáu h∆∞·ªõng d·∫´n',
                assignee: 'L√™ VƒÉn C',
                totalAmount: 15,
                completedAmount: 5,
                unit: 'trang',
                status: 'ƒêang th·ª±c hi·ªán',
                priority: 'Th·∫•p',
                deadline: '2024-12-05',
                issues: 'Thi·∫øu th√¥ng tin k·ªπ thu·∫≠t'
            },
            {
                id: 4,
                name: 'Test ch·ª©c nƒÉng thanh to√°n',
                assignee: 'Ph·∫°m Th·ªã D',
                totalAmount: 30,
                completedAmount: 0,
                unit: 'test case',
                status: 'M·ªõi',
                priority: 'Cao',
                deadline: '2024-11-20',
                issues: ''
            },
            {
                id: 5,
                name: 'T·ªëi ∆∞u hi·ªáu su·∫•t database',
                assignee: 'Ho√†ng VƒÉn E',
                totalAmount: 25,
                completedAmount: 12,
                unit: 'gi·ªù',
                status: 'B·ªã ch·∫∑n',
                priority: 'Cao',
                deadline: '2024-11-25',
                issues: 'C·∫ßn quy·ªÅn truy c·∫≠p production database'
            }
        ];

        sampleTasks.forEach(task => {
            push(tasksRef, task);
        });
    }

    // Save task to Firebase
    function saveTaskToFirebase(taskData, id = null) {
        if (id) {
            // Update existing
            update(ref(database, `tasks/${id}`), taskData);
        } else {
            // Add new (Firebase generates key, but we use custom ID)
            const newId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
            taskData.id = newId;
            push(tasksRef, taskData);
        }
    }

    // Delete task from Firebase
    function deleteTaskFromFirebase(id) {
        remove(ref(database, `tasks/${id}`));
    }

    // C√°c h√†m kh√°c gi·ªØ nguy√™n nh∆∞ code localStorage c≈©, nh∆∞ng g·ªçi saveTaskToFirebase thay v√¨ saveTasksToLocalStorage
    // Change role
    function changeRole() {
        const select = document.getElementById('roleSelect');
        currentRole = select.value;
        
        const roleSpan = document.getElementById('userRole');
        roleSpan.className = 'user-role';
        
        switch(currentRole) {
            case 'admin':
                roleSpan.className += ' role-admin';
                roleSpan.textContent = 'QU·∫¢N TR·ªä VI√äN';
                break;
            case 'manager':
                roleSpan.className += ' role-manager';
                roleSpan.textContent = 'QU·∫¢N L√ù';
                break;
            case 'viewer':
                roleSpan.className += ' role-viewer';
                roleSpan.textContent = 'NG∆Ø·ªúI XEM';
                break;
        }
        
        updateUIBasedOnRole();
    }

    // Update UI based on role
    function updateUIBasedOnRole() {
        const addTaskBtn = document.getElementById('addTaskBtn');
        const canEdit = currentRole === 'admin' || currentRole === 'manager';
        
        addTaskBtn.disabled = !canEdit;
        renderTasks(); // Re-render to update action buttons
    }

    // Render tasks (gi·ªØ nguy√™n nh∆∞ code c≈©)
    function renderTasks(filteredTasks = null) {
        const tbody = document.getElementById('taskTableBody');
        const tasksToRender = filteredTasks || tasks;
        
        if (tasksToRender.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="empty-state">
                        <h3>Kh√¥ng c√≥ c√¥ng vi·ªác n√†o</h3>
                        <p>B·∫•m "Th√™m c√¥ng vi·ªác m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = tasksToRender.map((task, index) => {
            const progress = (task.completedAmount / task.totalAmount * 100).toFixed(1);
            const remaining = task.totalAmount - task.completedAmount;
            const canEdit = currentRole === 'admin' || currentRole === 'manager';
            
            let statusClass = '';
            switch(task.status) {
                case 'M·ªõi': statusClass = 'status-new'; break;
                case 'ƒêang th·ª±c hi·ªán': statusClass = 'status-inprogress'; break;
                case 'Ho√†n th√†nh': statusClass = 'status-completed'; break;
                case 'B·ªã ch·∫∑n': statusClass = 'status-blocked'; break;
            }
            
            let priorityClass = '';
            switch(task.priority) {
                case 'Cao': priorityClass = 'priority-high'; break;
                case 'Trung b√¨nh': priorityClass = 'priority-medium'; break;
                case 'Th·∫•p': priorityClass = 'priority-low'; break;
            }
            
            return `
                <tr>
                    <td><strong>${index + 1}</strong></td>
                    <td><strong>${task.name}</strong></td>
                    <td>${task.assignee}</td>
                    <td>${task.totalAmount} ${task.unit || ''}</td>
                    <td>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${progress}%">
                                ${progress}%
                            </div>
                        </div>
                        <small style="color: #6c757d; margin-top: 5px; display: block;">
                            ${task.completedAmount} / ${task.totalAmount} ${task.unit || ''}
                        </small>
                    </td>
                    <td><strong>${remaining.toFixed(2)}</strong> ${task.unit || ''}</td>
                    <td><span class="status-badge ${statusClass}">${task.status}</span></td>
                    <td><span class="${priorityClass}">‚ö° ${task.priority}</span></td>
                    <td>
                        ${task.issues ? `<span class="issue-tag">‚ö†Ô∏è C√≥ v∆∞·ªõng m·∫Øc</span>` : '<span style="color: #28a745;">‚úì Kh√¥ng</span>'}
                        ${task.issues ? `<div class="tooltip"><small style="color: #6c757d; cursor: help;">Xem chi ti·∫øt</small><span class="tooltiptext">${task.issues}</span></div>` : ''}
                    </td>
                    <td>
                        <button class="btn btn-warning btn-small" onclick="editTask(${task.id})" ${!canEdit ? 'disabled' : ''}>
                            ‚úèÔ∏è S·ª≠a
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteTask(${task.id})" ${!canEdit ? 'disabled' : ''}>
                            üóëÔ∏è X√≥a
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Update statistics (gi·ªØ nguy√™n)
    function updateStatistics() {
        document.getElementById('totalTasks').textContent = tasks.length;
        
        const inProgress = tasks.filter(t => t.status === 'ƒêang th·ª±c hi·ªán').length;
        document.getElementById('inProgressTasks').textContent = inProgress;
        
        const completed = tasks.filter(t => t.status === 'Ho√†n th√†nh').length;
        document.getElementById('completedTasks').textContent = completed;
        
        const avgProgress = tasks.length > 0 
            ? (tasks.reduce((sum, t) => sum + (t.completedAmount / t.totalAmount * 100), 0) / tasks.length).toFixed(1)
            : 0;
        document.getElementById('avgProgress').textContent = avgProgress + '%';
    }

    // Filter tasks (gi·ªØ nguy√™n)
    function filterTasks() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const priorityFilter = document.getElementById('priorityFilter').value;
        
        let filtered = tasks.filter(task => {
            const matchesSearch = task.name.toLowerCase().includes(searchTerm) || 
                                task.assignee.toLowerCase().includes(searchTerm);
            const matchesStatus = !statusFilter || task.status === statusFilter;
            const matchesPriority = !priorityFilter || task.priority === priorityFilter;
            
            return matchesSearch && matchesStatus && matchesPriority;
        });
        
        renderTasks(filtered);
    }

    // Open add task modal (gi·ªØ nguy√™n)
    function openAddTaskModal() {
        if (currentRole === 'viewer') {
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn th√™m c√¥ng vi·ªác m·ªõi!');
            return;
        }
        
        document.getElementById('modalTitle').textContent = 'Th√™m c√¥ng vi·ªác m·ªõi';
        document.getElementById('taskForm').reset();
        document.getElementById('taskId').value = '';
        document.getElementById('taskModal').classList.add('active');
    }

    // Edit task (gi·ªØ nguy√™n, nh∆∞ng g·ªçi saveTask)
    function editTask(id) {
        if (currentRole === 'viewer') {
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a!');
            return;
        }
        
        const task = tasks.find(t => t.id === id);
        if (!task) return;
        
        document.getElementById('modalTitle').textContent = 'Ch·ªânh s·ª≠a c√¥ng vi·ªác';
        document.getElementById('taskId').value = task.id;
        document.getElementById('taskName').value = task.name;
        document.getElementById('assignee').value = task.assignee;
        document.getElementById('totalAmount').value = task.totalAmount;
        document.getElementById('unit').value = task.unit || '';
        document.getElementById('completedAmount').value = task.completedAmount;
        document.getElementById('status').value = task.status;
        document.getElementById('priority').value = task.priority;
        document.getElementById('deadline').value = task.deadline || '';
        document.getElementById('issues').value = task.issues || '';
        
        document.getElementById('taskModal').classList.add('active');
    }

    // Delete task
    function deleteTask(id) {
        if (currentRole === 'viewer') {
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a!');
            return;
        }
        
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác n√†y?')) {
            deleteTaskFromFirebase(id);
            // No need to re-render, Firebase listener will update automatically
        }
    }

    // Save task
    function saveTask(event) {
        event.preventDefault();
        
        if (currentRole === 'viewer') {
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn l∆∞u thay ƒë·ªïi!');
            return;
        }
        
        const id = document.getElementById('taskId').value;
        const taskData = {
            name: document.getElementById('taskName').value,
            assignee: document.getElementById('assignee').value,
            totalAmount: parseFloat(document.getElementById('totalAmount').value),
            completedAmount: parseFloat(document.getElementById('completedAmount').value),
            unit: document.getElementById('unit').value,
            status: document.getElementById('status').value,
            priority: document.getElementById('priority').value,
            deadline: document.getElementById('deadline').value,
            issues: document.getElementById('issues').value
        };
        
        saveTaskToFirebase(taskData, id ? parseInt(id) : null);
        closeModal();
        // Firebase will auto-update UI via listener
    }

    // Close modal (gi·ªØ nguy√™n)
    function closeModal() {
        document.getElementById('taskModal').classList.remove('active');
    }

    // Close modal when clicking outside (gi·ªØ nguy√™n)
    window.onclick = function(event) {
        const modal = document.getElementById('taskModal');
        if (event.target === modal) {
            closeModal();
        }
    }
</script>

